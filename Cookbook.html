<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Digital Cookbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        chef: {
                            50: '#fff8f1',
                            100: '#feecdc',
                            200: '#fcd5c2',
                            300: '#fcba9f',
                            400: '#f88f70',
                            500: '#f06543', // Primary Orange
                            600: '#db462c',
                            700: '#b63321',
                            800: '#922a21',
                            900: '#782620',
                        },
                        dark: {
                            800: '#1f2937',
                            900: '#111827',
                            950: '#0b0f19',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200 bg-chef-50 dark:bg-dark-950 min-h-screen flex flex-col transition-colors duration-300">

    <nav class="bg-white dark:bg-dark-900 border-b border-orange-100 dark:border-gray-800 sticky top-0 z-40 shadow-sm transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="app.showHome()">
                    <div class="bg-chef-500 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-utensils"></i>
                    </div>
                    <h1 class="font-serif text-2xl font-bold text-gray-900 dark:text-white tracking-tight">Cookbook</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.toggleTheme()" class="p-2 mr-1 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 transition-colors" title="Toggle Dark Mode">
                        <i class="fa-solid fa-moon block dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
                    </button>

                    <button onclick="app.exportRecipes()" class="hidden sm:flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-chef-600 dark:hover:text-chef-400 transition-colors">
                        <i class="fa-solid fa-download"></i> Export
                    </button>
                    <label class="hidden sm:flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-chef-600 dark:hover:text-chef-400 transition-colors cursor-pointer">
                        <i class="fa-solid fa-upload"></i> Import
                        <input type="file" id="importFile" accept=".json" class="hidden" onchange="app.importRecipes(this)">
                    </label>
                    <button onclick="app.openEditor()" class="ml-2 bg-chef-500 hover:bg-chef-600 text-white px-4 py-2 rounded-full font-medium shadow-md transition-all transform hover:scale-105 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">New Recipe</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
        
        <div id="view-home" class="animate-fade-in">
            <div class="mb-8 flex flex-col sm:flex-row gap-4 justify-between items-center">
                <div class="relative w-full sm:max-w-md">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Search recipes, ingredients..." 
                           class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-900 text-gray-900 dark:text-white focus:border-chef-500 focus:ring-2 focus:ring-chef-200 dark:focus:ring-chef-900 outline-none shadow-sm transition-all"
                           onkeyup="app.renderRecipeList()">
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    <span id="recipeCount">0</span> Recipes stored
                </div>
                <div class="flex sm:hidden w-full gap-2">
                     <button onclick="app.exportRecipes()" class="flex-1 items-center justify-center gap-2 px-3 py-2 bg-white dark:bg-dark-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300">
                        <i class="fa-solid fa-download"></i> Export
                    </button>
                    <label class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white dark:bg-dark-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300">
                        <i class="fa-solid fa-upload"></i> Import
                        <input type="file" accept=".json" class="hidden" onchange="app.importRecipes(this)">
                    </label>
                </div>
            </div>

            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
                <div class="bg-orange-100 dark:bg-gray-800 p-6 rounded-full mb-4 transition-colors">
                    <i class="fa-solid fa-book-open text-4xl text-chef-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">No recipes yet</h3>
                <p class="text-gray-500 dark:text-gray-400 max-w-sm mb-6">Your digital cookbook is looking a bit hungry. Start adding your favorite dishes!</p>
                <button onclick="app.openEditor()" class="text-chef-600 dark:text-chef-400 font-semibold hover:underline">Create your first recipe &rarr;</button>
            </div>

            <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>

        <div id="view-editor" class="hidden max-w-4xl mx-auto">
            <div class="bg-white dark:bg-dark-900 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-800 overflow-hidden transition-colors">
                <div class="border-b border-gray-100 dark:border-gray-800 px-6 py-4 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white" id="editorTitle">New Recipe</h2>
                    <button onclick="app.showHome()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="recipeForm" onsubmit="app.saveRecipe(event)" class="p-6 space-y-6">
                    <input type="hidden" id="editId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recipe Name</label>
                            <input type="text" id="recipeName" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-chef-200 dark:focus:ring-chef-900 focus:border-chef-500 outline-none" placeholder="e.g., Mom's Lasagna">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                            <textarea id="recipeDesc" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-chef-200 dark:focus:ring-chef-900 focus:border-chef-500 outline-none" placeholder="A short description of the dish..."></textarea>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"><i class="fa-regular fa-clock mr-1"></i> Prep Time</label>
                                <input type="text" id="recipePrep" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-chef-200 dark:focus:ring-chef-900 outline-none" placeholder="e.g. 30 mins">
                            </div>
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"><i class="fa-solid fa-users mr-1"></i> Base Servings</label>
                                <input type="number" id="recipeServings" required min="1" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-chef-200 dark:focus:ring-chef-900 outline-none" placeholder="e.g. 4">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-8 mt-6">
                        <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-xl transition-colors">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-serif font-bold text-lg text-gray-800 dark:text-white">Ingredients</h3>
                                <button type="button" onclick="app.addIngredientField()" class="text-xs bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-200 hover:border-chef-500 hover:text-chef-600 px-2 py-1 rounded shadow-sm transition-colors">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Item
                                </button>
                            </div>
                            <div class="grid grid-cols-10 gap-2 mb-2 px-1">
                                <span class="col-span-2 text-xs font-bold text-gray-500 uppercase">Amount</span>
                                <span class="col-span-2 text-xs font-bold text-gray-500 uppercase">Unit</span>
                                <span class="col-span-5 text-xs font-bold text-gray-500 uppercase">Ingredient</span>
                                <span class="col-span-1"></span>
                            </div>
                            <div id="ingredientsList" class="space-y-2">
                                </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-xl transition-colors">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-serif font-bold text-lg text-gray-800 dark:text-white">Instructions</h3>
                                <button type="button" onclick="app.addStepField()" class="text-xs bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-200 hover:border-chef-500 hover:text-chef-600 px-2 py-1 rounded shadow-sm transition-colors">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Step
                                </button>
                            </div>
                            <div id="stepsList" class="space-y-2">
                                </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-100 dark:border-gray-700">
                        <button type="button" onclick="app.showHome()" class="px-6 py-2 rounded-lg text-gray-600 dark:text-gray-400 font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-chef-500 text-white font-medium hover:bg-chef-600 shadow-md transition-all transform hover:-translate-y-0.5">Save Recipe</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="view-detail" class="hidden animate-fade-in max-w-4xl mx-auto">
            <button onclick="app.showHome()" class="mb-6 flex items-center text-gray-500 dark:text-gray-400 hover:text-chef-600 dark:hover:text-chef-400 transition-colors">
                <i class="fa-solid fa-arrow-left mr-2"></i> Back to Cookbook
            </button>
            
            <div id="recipe-content-to-print" class="bg-white dark:bg-dark-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800 overflow-hidden relative transition-colors">
                <div class="h-32 bg-gradient-to-r from-chef-400 to-chef-600 relative overflow-hidden">
                    <div class="absolute inset-0 opacity-20 pattern-dots"></div>
                    <div class="absolute -bottom-10 -right-10 text-white opacity-20">
                        <i class="fa-solid fa-utensils text-9xl"></i>
                    </div>
                </div>
                
                <div class="px-8 pb-8 -mt-12 relative">
                    <div class="bg-white dark:bg-dark-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 transition-colors">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 id="detailName" class="font-serif text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2"></h1>
                                <p id="detailDesc" class="text-gray-600 dark:text-gray-300 leading-relaxed"></p>
                            </div>
                            <div id="detailActions" class="flex gap-2 self-end md:self-start">
                                <button onclick="app.exportToPDF()" class="p-2 text-gray-400 hover:text-chef-600 hover:bg-orange-50 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Export as PDF">
                                    <i class="fa-solid fa-file-pdf"></i>
                                </button>
                                <button id="btnEdit" class="p-2 text-gray-400 hover:text-chef-600 hover:bg-orange-50 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Edit Recipe">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button id="btnDelete" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Delete Recipe">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-6 mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                            <span class="flex items-center text-gray-600 dark:text-gray-400">
                                <i class="fa-regular fa-clock mr-2 text-chef-500"></i> 
                                <span id="detailPrep"></span>
                            </span>
                            
                            <div class="flex items-center gap-3 bg-orange-50 dark:bg-gray-700/50 px-3 py-1 rounded-lg">
                                <span class="text-sm text-gray-500 dark:text-gray-400"><i class="fa-solid fa-users text-chef-500 mr-1"></i> Servings:</span>
                                <div class="flex items-center">
                                    <button onclick="app.adjustServings(-1)" class="w-6 h-6 rounded bg-white dark:bg-gray-600 hover:bg-chef-100 dark:hover:bg-gray-500 text-chef-600 dark:text-chef-400 flex items-center justify-center transition-colors shadow-sm">
                                        <i class="fa-solid fa-minus text-xs"></i>
                                    </button>
                                    <input type="number" id="detailServingsInput" value="4" readonly class="w-10 text-center bg-transparent font-bold text-gray-800 dark:text-white outline-none">
                                    <button onclick="app.adjustServings(1)" class="w-6 h-6 rounded bg-white dark:bg-gray-600 hover:bg-chef-100 dark:hover:bg-gray-500 text-chef-600 dark:text-chef-400 flex items-center justify-center transition-colors shadow-sm">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1">
                            <h3 class="font-serif text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 pb-2 border-b border-orange-100 dark:border-gray-700">Ingredients</h3>
                            <div id="detailIngredients" class="space-y-3">
                                </div>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="font-serif text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 pb-2 border-b border-orange-100 dark:border-gray-700">Instructions</h3>
                            <div id="detailSteps" class="space-y-4">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-50 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <i id="toastIcon" class="fa-solid fa-circle-check text-green-400 dark:text-green-600"></i>
        <span id="toastMessage" class="font-medium">Notification</span>
    </div>

    <script>
        // Unit Conversion Configuration
        const UNIT_DATA = {
            vol_imp: {
                base: 'tsp',
                units: [
                    { name: 'gal', val: 768 },
                    { name: 'qt', val: 192 },
                    { name: 'pt', val: 96 },
                    { name: 'cup', val: 48 },
                    { name: 'fl oz', val: 6 },
                    { name: 'tbsp', val: 3 },
                    { name: 'tsp', val: 1 }
                ]
            },
            vol_metric: {
                base: 'ml',
                units: [
                    { name: 'l', val: 1000 },
                    { name: 'ml', val: 1 }
                ]
            },
            wgt_imp: {
                base: 'oz',
                units: [
                    { name: 'lb', val: 16 },
                    { name: 'oz', val: 1 }
                ]
            },
            wgt_metric: {
                base: 'g',
                units: [
                    { name: 'kg', val: 1000 },
                    { name: 'g', val: 1 }
                ]
            }
        };

        const STANDARD_UNITS = [
            'tsp', 'tbsp', 'fl oz', 'cup', 'pt', 'qt', 'gal',
            'ml', 'l',
            'oz', 'lb',
            'g', 'kg',
            'can', 'pinch', 'clove', 'slice', 'pkg'
        ];

        const app = {
            recipes: [],
            currentRecipe: null, 
            currentServings: 1, 

            init() {
                this.initTheme();
                const stored = localStorage.getItem('cookbook_recipes');
                if (stored) {
                    try {
                        this.recipes = JSON.parse(stored);
                    } catch (e) {
                        this.recipes = [];
                    }
                }
                this.renderRecipeList();
            },

            initTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            toggleTheme() {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    html.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            },

            saveToStorage() {
                localStorage.setItem('cookbook_recipes', JSON.stringify(this.recipes));
                this.renderRecipeList();
            },

            // Navigation
            showHome() {
                document.getElementById('view-home').classList.remove('hidden');
                document.getElementById('view-editor').classList.add('hidden');
                document.getElementById('view-detail').classList.add('hidden');
                window.scrollTo(0,0);
            },

            openEditor(recipeId = null) {
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-detail').classList.add('hidden');
                document.getElementById('view-editor').classList.remove('hidden');
                
                const form = document.getElementById('recipeForm');
                const title = document.getElementById('editorTitle');
                
                document.getElementById('ingredientsList').innerHTML = '';
                document.getElementById('stepsList').innerHTML = '';

                if (recipeId) {
                    const recipe = this.recipes.find(r => r.id === recipeId);
                    if (!recipe) return this.showHome();

                    title.textContent = 'Edit Recipe';
                    document.getElementById('editId').value = recipe.id;
                    document.getElementById('recipeName').value = recipe.name;
                    document.getElementById('recipeDesc').value = recipe.description || '';
                    document.getElementById('recipePrep').value = recipe.prepTime || '';
                    document.getElementById('recipeServings').value = recipe.servings || 1;

                    // Handle Backward Compatibility for Ingredients
                    recipe.ingredients.forEach(ing => {
                        if (typeof ing === 'string') {
                            this.addIngredientField('', '', ing);
                        } else {
                            this.addIngredientField(ing.qty, ing.unit, ing.name);
                        }
                    });
                    
                    recipe.steps.forEach(step => this.addStepField(step));
                } else {
                    title.textContent = 'New Recipe';
                    form.reset();
                    document.getElementById('editId').value = '';
                    document.getElementById('recipeServings').value = 4; // Default
                    this.addIngredientField();
                    this.addStepField();
                }
                window.scrollTo(0,0);
            },

            openDetail(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                this.currentRecipe = recipe;
                this.currentServings = parseInt(recipe.servings) || 1;

                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-editor').classList.add('hidden');
                document.getElementById('view-detail').classList.remove('hidden');

                document.getElementById('detailName').textContent = recipe.name;
                document.getElementById('detailDesc').textContent = recipe.description || 'No description provided.';
                document.getElementById('detailPrep').textContent = recipe.prepTime || '--';
                
                // Set initial servings input
                document.getElementById('detailServingsInput').value = this.currentServings;

                // Setup Actions
                document.getElementById('btnEdit').onclick = () => this.openEditor(recipe.id);
                document.getElementById('btnDelete').onclick = () => {
                    if(confirm(`Delete "${recipe.name}"?`)) {
                        this.deleteRecipe(recipe.id);
                    }
                };

                // Render Instructions with "Done" functionality
                const stepList = document.getElementById('detailSteps');
                stepList.innerHTML = recipe.steps.map((step, index) => `
                    <label class="flex gap-4 group cursor-pointer select-none">
                        <input type="checkbox" class="peer sr-only">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-chef-100 dark:bg-chef-900 text-chef-600 dark:text-chef-400 font-bold flex items-center justify-center text-sm transition-all peer-checked:bg-green-500 peer-checked:text-white">
                            <span class="group-hover:hidden peer-checked:hidden">${index + 1}</span>
                            <i class="fa-solid fa-check hidden group-hover:block peer-checked:block"></i>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mt-1 leading-relaxed peer-checked:text-gray-400 peer-checked:line-through transition-colors">
                            ${this.escapeHtml(step)}
                        </p>
                    </label>
                `).join('');

                // Render Scaled Ingredients
                this.renderScaledIngredients();

                window.scrollTo(0,0);
            },

            // PDF Export Function
            exportToPDF() {
                if (!this.currentRecipe) return;

                const element = document.getElementById('recipe-content-to-print');
                const actions = document.getElementById('detailActions');
                
                // Temporarily hide buttons for the print
                if(actions) actions.style.display = 'none';

                const opt = {
                    margin:       0.5,
                    filename:     `${this.currentRecipe.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    // Bring buttons back
                    if(actions) actions.style.display = 'flex';
                }).catch(err => {
                    console.error(err);
                    if(actions) actions.style.display = 'flex';
                    this.showToast('Error creating PDF', 'error');
                });
            },

            adjustServings(change) {
                let newS = this.currentServings + change;
                if (newS < 1) newS = 1;
                this.currentServings = newS;
                document.getElementById('detailServingsInput').value = newS;
                this.renderScaledIngredients();
            },

            // SMART CONVERSION LOGIC
            smartConvert(qty, unit) {
                // Find which family this unit belongs to
                let family = null;
                if (UNIT_DATA.vol_imp.units.some(u => u.name === unit)) family = UNIT_DATA.vol_imp;
                else if (UNIT_DATA.vol_metric.units.some(u => u.name === unit)) family = UNIT_DATA.vol_metric;
                else if (UNIT_DATA.wgt_imp.units.some(u => u.name === unit)) family = UNIT_DATA.wgt_imp;
                else if (UNIT_DATA.wgt_metric.units.some(u => u.name === unit)) family = UNIT_DATA.wgt_metric;

                // If not a scalable unit family (e.g. 'can'), just return scaled qty
                if (!family) return { qty, unit };

                // 1. Normalize to base unit (e.g. tsp or ml)
                const currentUnitData = family.units.find(u => u.name === unit);
                const baseQty = qty * currentUnitData.val;

                // 2. Find best fit
                // Iterate largest to smallest
                for (const u of family.units) {
                    const converted = baseQty / u.val;
                    // Threshold: We switch to this unit if the value is >= 0.25 (e.g. 1/4 cup)
                    // But if it's the smallest unit, we just take it.
                    if (converted >= 0.25 || u.name === family.units[family.units.length - 1].name) {
                        return { qty: converted, unit: u.name };
                    }
                }
                return { qty, unit };
            },

            renderScaledIngredients() {
                if (!this.currentRecipe) return;

                const baseServings = parseInt(this.currentRecipe.servings) || 1;
                const ratio = this.currentServings / baseServings;
                
                const listEl = document.getElementById('detailIngredients');
                
                listEl.innerHTML = this.currentRecipe.ingredients.map(ing => {
                    let displayString = "";

                    if (typeof ing === 'string') {
                        // Legacy support
                        displayString = this.escapeHtml(ing);
                    } else {
                        // Structured Support
                        let qtyDisplay = "";
                        let finalUnit = ing.unit;
                        
                        if (ing.qty) {
                            let scaledRaw = parseFloat(ing.qty) * ratio;
                            
                            // Try Smart Conversion ONLY if servings have been changed (ratio != 1)
                            if (ing.unit && ratio !== 1) {
                                const result = this.smartConvert(scaledRaw, ing.unit);
                                scaledRaw = result.qty;
                                finalUnit = result.unit;
                            }

                            // Rounding to 2 decimal places max
                            let val = Math.round(scaledRaw * 100) / 100; 
                            qtyDisplay = `<span class="font-bold text-chef-600 dark:text-chef-400 mr-1">${val}</span>`;
                        }
                        
                        let unitDisplay = finalUnit ? `<span class="text-gray-500 dark:text-gray-400 mr-1 text-sm">${this.escapeHtml(finalUnit)}</span>` : '';
                        
                        displayString = `${qtyDisplay}${unitDisplay}${this.escapeHtml(ing.name)}`;
                    }

                    // Checkbox UI
                    return `
                    <label class="flex items-start gap-3 p-3 hover:bg-orange-50 dark:hover:bg-gray-800 rounded-xl transition-colors cursor-pointer select-none">
                        <input type="checkbox" class="peer sr-only">
                        <div class="w-6 h-6 flex-shrink-0 rounded-full border-2 border-gray-300 dark:border-gray-600 peer-checked:bg-chef-500 peer-checked:border-chef-500 flex items-center justify-center transition-all mt-0.5">
                            <i class="fa-solid fa-check text-white text-xs opacity-0 peer-checked:opacity-100 transform scale-50 peer-checked:scale-100 transition-transform"></i>
                        </div>
                        <div class="text-gray-700 dark:text-gray-300 peer-checked:text-gray-400 peer-checked:line-through transition-colors">
                            ${displayString}
                        </div>
                    </label>`;
                }).join('');
            },

            // Form Logic
            addIngredientField(qty = '', unit = '', name = '') {
                // Ensure dropdown supports existing unit even if custom
                let optionsHtml = '<option value="">Unit</option>';
                let found = false;
                
                STANDARD_UNITS.forEach(u => {
                    const selected = u === unit ? 'selected' : '';
                    if (u === unit) found = true;
                    optionsHtml += `<option value="${u}" ${selected}>${u}</option>`;
                });

                // If existing unit is not in standard list, add it dynamically
                if (unit && !found) {
                     optionsHtml += `<option value="${this.escapeHtml(unit)}" selected>${this.escapeHtml(unit)}</option>`;
                }

                const div = document.createElement('div');
                div.className = 'grid grid-cols-10 gap-2 ing-row';
                div.innerHTML = `
                    <input type="number" step="any" placeholder="1" value="${qty}" class="ing-qty col-span-2 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded border border-gray-200 dark:border-gray-600 focus:border-chef-500 outline-none text-sm">
                    <select class="ing-unit col-span-2 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded border border-gray-200 dark:border-gray-600 focus:border-chef-500 outline-none text-sm appearance-none">
                        ${optionsHtml}
                    </select>
                    <input type="text" placeholder="Flour" value="${this.escapeHtml(name)}" class="ing-name col-span-5 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded border border-gray-200 dark:border-gray-600 focus:border-chef-500 outline-none text-sm">
                    <button type="button" onclick="this.parentElement.remove()" class="col-span-1 text-gray-400 hover:text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                `;
                document.getElementById('ingredientsList').appendChild(div);
            },

            addStepField(value = '') {
                const div = document.createElement('div');
                div.className = 'flex gap-2';
                div.innerHTML = `
                    <textarea placeholder="e.g. Mix the dry ingredients..." class="step-input flex-1 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded border border-gray-200 dark:border-gray-600 focus:border-chef-500 outline-none text-sm" rows="2">${this.escapeHtml(value)}</textarea>
                    <button type="button" onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500 px-2 self-start mt-2"><i class="fa-solid fa-trash-can"></i></button>
                `;
                document.getElementById('stepsList').appendChild(div);
            },

            saveRecipe(e) {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const name = document.getElementById('recipeName').value;
                const desc = document.getElementById('recipeDesc').value;
                const prep = document.getElementById('recipePrep').value;
                const servings = document.getElementById('recipeServings').value;

                // Collect structured ingredients
                const ingredientRows = document.querySelectorAll('.ing-row');
                const ingredients = [];
                ingredientRows.forEach(row => {
                    const qty = row.querySelector('.ing-qty').value.trim();
                    const unit = row.querySelector('.ing-unit').value.trim();
                    const itemName = row.querySelector('.ing-name').value.trim();
                    
                    if (itemName) {
                        ingredients.push({ qty, unit, name: itemName });
                    }
                });
                
                const steps = Array.from(document.querySelectorAll('.step-input'))
                    .map(input => input.value.trim()).filter(v => v);

                if (ingredients.length === 0 || steps.length === 0) {
                    this.showToast('Please add at least one ingredient and step!', 'error');
                    return;
                }

                const recipeData = {
                    name, 
                    description: desc, 
                    prepTime: prep, 
                    servings: servings, 
                    ingredients, 
                    steps, 
                    updatedAt: new Date()
                };

                if (id) {
                    const index = this.recipes.findIndex(r => r.id === id);
                    if (index !== -1) {
                        this.recipes[index] = { ...this.recipes[index], ...recipeData };
                    }
                } else {
                    const newRecipe = {
                        id: Date.now().toString(),
                        ...recipeData,
                        createdAt: new Date()
                    };
                    this.recipes.unshift(newRecipe);
                }

                this.saveToStorage();
                this.showHome();
                this.showToast('Recipe saved successfully!');
            },

            deleteRecipe(id) {
                this.recipes = this.recipes.filter(r => r.id !== id);
                this.saveToStorage();
                this.showHome();
                this.showToast('Recipe deleted.');
            },

            // Import / Export
            exportRecipes() {
                if (this.recipes.length === 0) {
                    this.showToast('No recipes to export!', 'error');
                    return;
                }
                const dataStr = JSON.stringify(this.recipes, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cookbook_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('Cookbook exported!');
            },

            importRecipes(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            let count = 0;
                            imported.forEach(newR => {
                                if(newR.name) {
                                    newR.id = Date.now().toString() + Math.random().toString(36).substr(2, 9); 
                                    this.recipes.unshift(newR);
                                    count++;
                                }
                            });
                            this.saveToStorage();
                            this.showToast(`${count} recipes imported successfully!`);
                        }
                    } catch (err) {
                        this.showToast('Failed to import file.', 'error');
                    }
                    input.value = '';
                };
                reader.readAsText(file);
            },

            renderRecipeList() {
                const grid = document.getElementById('recipeGrid');
                const empty = document.getElementById('emptyState');
                const countSpan = document.getElementById('recipeCount');
                const term = document.getElementById('searchInput').value.toLowerCase();

                const filtered = this.recipes.filter(r => {
                    const nameMatch = r.name.toLowerCase().includes(term);
                    const ingMatch = r.ingredients && r.ingredients.some(i => {
                        if (typeof i === 'string') return i.toLowerCase().includes(term);
                        return i.name.toLowerCase().includes(term);
                    });
                    return nameMatch || ingMatch;
                });

                countSpan.textContent = filtered.length;

                if (filtered.length === 0) {
                    grid.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                grid.innerHTML = filtered.map(recipe => `
                    <div onclick="app.openDetail('${recipe.id}')" class="bg-white dark:bg-dark-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 hover:shadow-md hover:border-chef-200 dark:hover:border-gray-700 transition-all cursor-pointer group flex flex-col h-full overflow-hidden">
                        <div class="h-32 bg-orange-50 dark:bg-gray-800 relative overflow-hidden group-hover:bg-orange-100 dark:group-hover:bg-gray-700 transition-colors">
                            <div class="absolute inset-0 flex items-center justify-center text-chef-200 dark:text-gray-600 group-hover:text-chef-300 dark:group-hover:text-gray-500 transition-colors">
                                <i class="fa-solid fa-utensils text-5xl transform -rotate-12"></i>
                            </div>
                        </div>
                        <div class="p-5 flex-grow flex flex-col">
                            <h3 class="font-serif font-bold text-xl text-gray-800 dark:text-gray-100 mb-2 line-clamp-1 group-hover:text-chef-600 dark:group-hover:text-chef-400 transition-colors">${this.escapeHtml(recipe.name)}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-2 flex-grow">${this.escapeHtml(recipe.description || 'No description.')}</p>
                            
                            <div class="flex items-center justify-between text-xs font-medium text-gray-400 dark:text-gray-500 pt-4 border-t border-gray-50 dark:border-gray-800">
                                <span class="flex items-center"><i class="fa-regular fa-clock mr-1"></i> ${this.escapeHtml(recipe.prepTime || '--')}</span>
                                <span class="flex items-center"><i class="fa-solid fa-list-ul mr-1"></i> ${recipe.ingredients.length} ings</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            showToast(msg, type = 'success') {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toastIcon');
                const text = document.getElementById('toastMessage');
                text.textContent = msg;
                if (type === 'error') {
                    icon.className = 'fa-solid fa-circle-exclamation text-red-400';
                } else {
                    icon.className = 'fa-solid fa-circle-check text-green-400 dark:text-green-500';
                }
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            },

            escapeHtml(text) {
                if (!text) return '';
                return String(text)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>